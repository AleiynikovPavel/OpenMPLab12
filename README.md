# MPILab12

### Задание (вариант 6)
Задача о вычислении произведения матриц-2. Даны матрицы A размерностью n1 строк на n2 столбцов и матрица B размерностью n2 строк на n3 столбцов. Исходные данные хранятся в файлах на диске, подготовленные для каждого процессора (написать последовательную программу подготовки данных, входным параметром которой является число процессоров). Написать программу для p процессоров (2<=p<<n1,n2,n3, p%n1, p%n2, p%n3 != 0), вычисляющую произведение матриц AB, собирающую результат в 0-м процессоре, который сбрасывает его в файл. Распределение нагрузки на процессоры провести наиболее удобным способом. Использовать алгоритм с топологией «2D решетка» и парадигмой управляющий-рабочий (в начале программы 0-й процессор считывает все данные и распределяет по процессорам).
### Структура проекта
Проект состоит из двух программ:
* `DataPreprocessor` - программа проводит разбиение матриц на подматрицы для каждого процесса. Далее доматрицы идут в `MultiplicationCompute` для умножения `A` на `B`.
  * принимает на вход число процессов, и входные матрицы в файлах `A.txt` и `B.txt`
  * программа выдаёт подматрицы в файлах:
    * `A_0.txt`, `A_1.txt`, ... , `A_i.txt` для матрицы `A`
    * `B_0.txt`, `B_1.txt`, ... , `B_j.txt` для матрицы `B`
* `MultiplicationCompute` - программа средствами MPI проводит умножение матриц используя файлы `A_i.txt`, `B_j.txt` и складывает результат в файл `C.txt`. 

### Особенности реализации
* Для разбиения процессов в топологию 2D решётка необходимо определить число процессов в каждом измерении (число строк и столбцов топологии). Для этого можно использовать метод `MPI_Dims_create` из библиотеки MPI, но так как в данном случае разбиение выполняет последовательная программа без `MPI`, то реализован свой метод разбиения. Однако он не всега находит максимально близкие друг к другу делители числа `n`, так:
  * Для `n` = 4, число измерений будет (2,2)
  * Для `n` = 3, число измерений будет (3,1)
  * Для `n` = 20, число измерений будет (10,2), **но более хорошим вариантом от MPI_Dims_create будет (4, 5)**
* В случае если число строк/столбцов матрицы не делится нацело  на число процессов в соответствующем измерении, то матрица будет поделена на n-1 равный блок, а блок n будет равен размеру предыдущих блоков плюс остаток от деления числа строк/столбцов на число процессов в измерении.
* Процессы работают в парадигме мастер/рабочий, но мастер процесс также принимает участие в вычислении произведения, помимо того, что распределяет и собирает данные от рабочих процессов.
### Запуск
* `$ cd data` - перейти в папку с входными данными и собранными бинарниками программ
* `$ ./compute.sh n` - запустить скрипт с параметром `n`. `n` это число процессов и `n` >= 2 


### Вывод программы
Тест на следующих матрицах: 
* **A**
```
0 1 2 3
4 5 6 7
8 9 10 11
12 13 14 15
16 17 18 19
20 21 22 23
24 25 26 27
```

* **B**
```
0 1 2 3 4 5 6 7 8
9 10 11 12 13 14 15 16 17
18 19 20 21 22 23 24 25 26
27 28 29 30 31 32 33 34 35
```
#### Для n = 6

<details>

* **A_0**
```
0 1 2 3
4 5 6 7
8 9 10 11
```
* **A_1**
```
12 13 14 15
16 17 18 19
20 21 22 23
24 25 26 27
```
* **B_0**
```
0 9 18 27
1 10 19 28
2 11 20 29
```
* **B_1**
```
3 12 21 30
4 13 22 31
5 14 23 32
```
* **B_2**
```
6 15 24 33
7 16 25 34
8 17 26 35
```
* **C**
```
126 132 138 144 150 156 162 168 174
342 364 386 408 430 452 474 496 518
558 596 634 672 710 748 786 824 862
774 828 882 936 990 1044 1098 1152 1206
990 1060 1130 1200 1270 1340 1410 1480 1550
1206 1292 1378 1464 1550 1636 1722 1808 1894
1422 1524 1626 1728 1830 1932 2034 2136 2238
```
</details>

#### Для n = 3

<details>

* **A_0**
```
0 1 2 3
4 5 6 7
```
* **A_1**
```
8 9 10 11
12 13 14 15
```
* **A_2**
```
16 17 18 19
20 21 22 23
24 25 26 27
```
* **B_0**
```
0 9 18 27
1 10 19 28
2 11 20 29
3 12 21 30
4 13 22 31
5 14 23 32
6 15 24 33
7 16 25 34
8 17 26 35
```
* **C**
```
126 132 138 144 150 156 162 168 174
342 364 386 408 430 452 474 496 518
558 596 634 672 710 748 786 824 862
774 828 882 936 990 1044 1098 1152 1206
990 1060 1130 1200 1270 1340 1410 1480 1550
1206 1292 1378 1464 1550 1636 1722 1808 1894
1422 1524 1626 1728 1830 1932 2034 2136 2238
```
</details>


